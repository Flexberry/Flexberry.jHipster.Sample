# Аутентификация и полномочия

При инициализации проекта есть три вида аутентификации на выбор:
- JWT Authentication 
- HTTP Session Authentication
- OAuth 2.0 / OIDC Authentication 

## JWT Authentication (JSON Web Token)
В этом решении используется безопасный токен, который содержит имя пользователя и полномочия. Поскольку токен подписан, пользователь не может его изменить.

По умолчанию такого механизма нет в Spring Security, это специальная JHipster интеграция.

JHipster использует секретный ключ, который можно настроить с помощью двух свойств Spring Boot: **jhipster.security.authentication.jwt.secret** и **jhipster.security.authentication.jwt.base64-secret**. Второй вариант использует строку в кодировке Base64, поэтому он считается более безопасным. Эти ключи имеют длину в 512 битов.

Секретные ключи настраиваются в файлах **application-*.yml**. 

JHipster автоматически отслеживает недействительные токены, реализовано это как специальная метрика приложения.

Это хороший выбор в том случае, если планируется масштабирование приложения на несколько серверов.

Используется по умолчанию при выборе микросервисной архитектуры.

## HTTP Session Authentication 

Классический механизм аутентификации Spring Security. 

Использует HTTP-сессию, поэтому это механизм с отслеживанием состояния. Если планируется масштабировать приложение на нескольких серверах, то нужен балансировщик нагрузки с фиксированными сессиями, чтобы каждый пользователь оставался на одном сервере, или вариант добавить Spring Session для хранения сеанса в базе данных, а не в памяти.

В JHipster этот механизм запоминания Spring Security был модифицирован, чтобы в системе был уникальный токен, который хранится в базе данных. Также хранится больше информации, чем стандартная реализация: IP-адрес, браузер, дата и т.п… Был создан полный экран администрирования, чтобы можно было аннулировать сеансы, например, если кто-то забыл выйти на другом компьютере. 

Так же был модифицирован механизм хранения файлов cookie, теперь они хранятся еще и а базе данных. Эти значения меняются каждый раз когда пользователь заходит в систему. Таким образом, если кто-то украдет файл cookie, он сможет использовать его не более одного раза.

Для аутентификации с функцией запоминания, ключ запоминания настраивается в файлах application-dev.yml и application-prod.yml как свойство jhipster.security.remember-me.key.

## OAuth 2.0 / OIDC Authentication 

OAuth — это стандарт, который приложения могут использовать для предоставления клиентским приложениям «безопасного делегированного доступа».

В этом сценарии конечный пользователь общается со своим поставщиком удостоверений, и поставщик удостоверений создает криптографически подписанный токен, который он передает приложению для аутентификации пользователя. Приложение доверяет поставщику удостоверений. Все в порядке, пока эти доверительные отношения работают.

JHipster поддерживает версию OAuth 2.0.

Этот вариант взаимодействует с сервисами **Keycloak** (по умолчанию) или **Okta**.

### Keycloak

Keycloak продукт с открытым кодом для реализации single sign-on с возможностью управления доступом, нацелен на современные приложения и сервисы. Целью этого инструмента является сделать создание безопасных приложений и сервисов с минимальным написанием кода для аутентификации и авторизации.

Функции:
- Регистрацию пользователей
- Авторизация через соц.сети
- Single Sign-On / Sign-Off для всех приложений одного реалма (англ. Realm)
- Выдача JSON Web Token подлинности аккаунтам
- Двухфакторная аутентификация
- Интеграция со службами каталогов (LDAP-сервером)
- Брокер Kerberos
- Поддержка разных реалмов, с возможностью настройки внешнего вида страницы логина для каждой области

### Okta

Okta — это облачный сервис, который позволяет управлять удостоверениями и доступом. Согласно документации Okta, это сервис корпоративного уровня, который создан для управления удостоверениями в облачной среде, но при этом совместим и со многими локальными приложениями. С его помощью можно управлять доступом сотрудников к любому приложению или устройству. Сервис развернут на надежной и защищенной облачной платформе, которая обладает широкими возможностями аудита и тесно интегрируется с локальными приложениями, службами каталогов и системами управления удостоверениями.

## Настройка секретных ключей

Для **JWT** и **HTTP Session** аутентификации актуальна проблема хранения ключей пользователей.

Поскольку ключи должны храниться в секрете, то надо хранить их в безопасном месте для своего производственного профиля. Его можно настроить с помощью обычной конфигурации свойств Spring Boot. 

С помощью сервера Spring Cloud Config, такого как **JHipster Registry** (настраивается отдельно), с использованием переменной среды или даже определенного файла application-prod.yml, который создается в Spring Cloud Config системным администратором в тот же каталог, что и исполняемый WAR-файл приложения.

## Статьи

1. [JSON Web Token](https://jwt.io/)
2. [Java JWT](https://github.com/jwtk/jjwt#java-jwt-json-web-token-for-java-and-android)
3. [JHipster Registry](https://www.jhipster.tech/jhipster-registry/)
4. [Что такое OAuth](https://developer.okta.com/blog/2017/06/21/what-the-heck-is-oauth)
5. [Keycloak](https://www.keycloak.org/)
6. [Okta CLI](https://cli.okta.com/)